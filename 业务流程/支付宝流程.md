## 支付宝数据库操作流程

### 1.前端发json数据格式

```go
param = {"addrId":addrId,"payId":payId,"skuids":skuids,            "totalCount":parseInt(totalCount),"totalPrice":parseInt(totalPrice),"transit":parseInt(transit)}
```

addrId//地址Id  

payId//支付方式id

skuids//所有商品id

```go
//获取总件数，总价格，快递费
totalCount   totalPrice    transit
```



### 2.把数据插入订单表里面

models.InsertOrderInfoList(userName.(string),addrId, payId,skuids, totalCount, totalPrice, transit)

返回成功码200  status=200  前端回调函数判断 如果是200的话

在发一次请求

```go
window.location.href = '/user/userCenterOrder';
```



### 3.细讲插入订单表

#### 一.赋值

```go
//获取orm数据库里面对象
o := orm.NewOrm()
//获取结构体
var orderinfo OrderInfo
//赋值
//--付款方式
orderinfo.PayMethod = payId
//--商品数量
orderinfo.TotalCount = totalCoun
//--商品总价
orderinfo.TotalPrice = totalPrice
//--快递费用
orderinfo.TransitPrice = transit

```

#### 二.要先进行user用户查询

```go
//用户的对象指针
var user Useruser.Name = userName
//查询user用户
err = o.Read(&user, "Name")
if err != nil {
		return err, "查询user用户错误"
	}
```

#### 三.用户成功了查询地址表address

```go
var address Address
address.Id = addrId
err = o.Read(&address)
if err != nil {   
    return err, "查询address地址表错误"
}

```

#### 四.在插入订单表前要进行判断

```go
//orderinfo赋值
orderinfo.Address = &address
orderinfo.User = &user
//把订单号添加上去
//要创建一个独特订单id
orderId := time.Now().Format("200601021504051234") + strconv.Itoa(user.Id)
//赋值
orderinfo.OrderId = orderId
```

#### 五.现在进行事务开始

```go
//开启回滚
o.Begin()
_, err = o.Insert(&orderinfo)
if err != nil {  
    //如果错误就进行
    o.Rollback()   
    return err, "插入订单表"}
//处理skuids数据
//全部商品id  它是全部 ["id1 id2 id3"] 字符串
//要掐头去尾
//掐头去尾 skuids[1:len(skuids)-1]
	skuqieb := strings.Split(skuids[1:len(skuids)-1], " ")
for _, cartId := range skuqieb {
    var ordergoods OrderGoods
		ordergoods.OrderInfo = &orderinfo
		//循环数据
    
    //根据id查到商品
    var goodssku GoodsSKU
    var count int
    //A点循环开始    要循环10次
    //把商品id进行转化
	Idint, err := strconv.Atoi(cartId)
    if err != nil {
		o.Rollback()//id转化错误回滚
		return err, "id字符转成int类型"
	}
    goodssku.Id = Idint
    //查询商品
    err = o.Read(&goodssku, "Id")
	if err != nil {
		o.Rollback()
		return err, "循环读goodssku"
    }
    //储存一个历史商品库存
    historyStock:=goodssku.Stock
    //这里可以开始模拟网卡 暂停十秒
    time.Sleep(10 * time.Second)
    //在结束在查询下
    o.Read(&goodssku)
    //查询redis数据库 可以查到
    count, err = redis.Int(conn.Do("hget", userName+"_host", Idint))
    if err != nil {
	o.Rollback()
	return err, "redis读哈希表 商品数量错误"
	}
    //在插入时候
    fmt.Println("历史库存为,", historyStock, "现在库存为,", goodssku.Stock)
    		ordergoods.GoodsSKU = &goodssku
			ordergoods.Count = count
			ordergoods.Price = count * goodssku.Price
    		//进行判断
			if goodssku.Stock < count {
				o.Rollback()
				return errors.New("店家库存不够"), "店家的" + goodssku.Name + "库存不够"
			}
			if goodssku.Stock != historyStock {
				if i >= 0 {
					i -= 1
				} else {
					o.Rollback()
					return errors.New("店家库存不够"), "店家的" + goodssku.Name + "库存不够"
				}
			} else {
				conn.Do("hdel", userName+"_host", Idint)
				break
			}
		}
		_, err = o.Insert(&ordergoods)

		if err != nil {
			o.Rollback()
			return err, "插入订单商品表错误"
		}
		goodssku.Stock -= count
		goodssku.Sales += count
		o.Update(&goodssku, "Stock", "Sales")
		//A结束点
		//插入订单商品表
		o.Commit()
		return nil, ""
}
```

###### 表插入结束了



#### 6.成功了进行跳转到支付页面

```go
var privateKey =`MIIEpAIBAAKCAQEAvaLI0mc/eDS0ysmR1+pOTqLNVgWafDBKDWOWXYjU5prslw8XKTs+zvC8SXMaqER4VaEdaFpTrk3QefiClc6MY7L08TxyG0Y+PXFaSJup43cgM8FBBYf+lmhoqPK61o1aTv0JrFD0KPiEV/QZDbkIsmTKrdKLv2EQq1XumS+vxI95qi4BvmzAKWRri7n8oFU13gH+Ics2y7NVD6TDtRVEV6OfOvDgpLnmLXq2tj38lnSLBRgP4GS/w+Pfh64D9lcTxn69RudD+Sxz6vYoW7uaziSjq15Ni3LURev/IZ34Kzk12GjPPDW2pAQIpDXzaPkVQYXuQ4Oz5ZaKsGF0Yv5ipQIDAQABAoIBAAPGrwsJhUkGe6ciFmZfQwnr0fzphab9aywTFJZuOBcTdKyZX1Ox21FRl946jYhWPLMvzx8Z1Vq+L+2N1kPXZhJCKQB4vKjwYCLnE+4oM1zVLW36ZioPCDHEiHj8xF2rWOYDweKNhh8eu7von2sXiSXMPgDyFVhNPYC76FFikrRuQiOfQDQtZiUr6fyeYpKjEL0xI6cJym1hYqmDgtvctzggDCiQj7JMBUH44+GmiNCnGLzNG6RmbS0TA8gEuQu8z73qzTItEMTJjCaJnQPcdKa3YlhWQZoTSfl910l1W4mhyuubB540ipVHRJTulrgb7I1x2UyJ5Ff+nc+46SQmuo0CgYEA8zJ0FPfC822hUA+4dA7ZMMCiF61TZdxj+daAKEUMB7hU1a9GN1FYc6bf2dfUIH6vlKKvpK/8SA7mPd3OXMMo9XupLodcvfHd/yT4a+jmx4Qv96j1wfNeioJh1CP7VLS0OMSwsZMbNo6UMZhIs+6Au9YKyrYBduvePo7xFuhMLgMCgYEAx559vD0H5bspee7jSTOXNrHl6fN/klLN4HEEXMlgUdb3of7fYSnZMpOF5sRwC7mgM84ifucHDhHv7ZME6ZxawC9DlgLGj92oHgzata+NH5CRynhiR6eZFaBD+6fIf/VgMltUnVH5MXSbnPEEqRONNaUTan1irZk2eMplA581gDcCgYEA6DDUiaxfsiCKcjEAL7Z5gMV6PNbcGBWKUl+MbmY17Sz9uiKlDG2a4JiDgq5AtmGd63BD+B2Z5YZsJscdno0qDu5pAaZ1UliZVl+K2yQ7KmQ3k+H5+ZoNOnrvQia0cBQzOTv5YyELS1Rngs5dI4Vj3XKnTRDmZw8dWmcJIZDaItcCgYEAnUmFuye/rEWAFeKkVk5/TIp6JZBGqc3zCHEkxdOqwHGIp61C57VovZA+BqoruyFlWMyIo8N37J83lNOuIEChxSK4t1+ygzNdP2hTgKs1oHRyW73lep5VYhPo3UbEFgcK6ELMdjVcC5rc7pl+WZbdQjKzDMqFUVIS+LRJScRODJsCgYB5PLWqzyTelIgE/ocSnpF94CzV4WQTi/9k4xjikFNUJPJVOKztHM3CDr7ayz24CSyIHHXH777sU86RAIAY75nJgoSmlpFR7nKdDo7I0q3ETCSi3sTS7L0fr3Ql55OeUcIs5CmAZzvMFrGuWLPzNDutXa6XwLxbPmviNwNmv6ph5g==`
var appId = "2016101200668306"   

var aliPublicKey=
`MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAq5pdKVjpZzvKFaXFMOUYg/7YggJiZ9NZQlShikRiI2Q847JG0f1pZqv4aCqn7CbOTYeM9QXkwLJ4Q1GxU9tc05j+mpDu3zZyaFccSyD5rQHP7S3pdKqu+NnbZ0M2mHS3aepwjyx3hUBW0XeZH08MGaH2yiW+UmsEpJSVgCTqCUEgaV7+tGGDT+f7b501cYKdWQgB02GagzfwsznGHTP/nUWMLC6/Gp9orv+67j7aMLZqwdqpopGW4Os44rPClJyMRrDH/zncNWDwxFazXqASKnDYC5J8lzi3ltL0QN4LC611FPxiw6/5G48hQfLgxf50cuLwXEngLhB9iKEYpo0aHQIDAQAB`   
//func New(appId, aliPublicKey, privateKey string, isProduction bool) (client *Client, //err error) {

client ,err:= alipay.New(appId,aliPublicKey,privateKey,false)
if err!=nil {
		this.Data["errer"]="支付失败"
		this.TplName="place_order.html"
		return
	}
//支付配置
	p :=alipay.TradePagePay{}
	//设置支付主题
	p.Subject="学校生鲜平台"
	//设置订单号
	p.OutTradeNo="201909270150266"
	//设置支付金额
	p.TotalAmount="1000.00"
	//设置异步返回方式
	p.NotifyURL="http://192.168.73.128:8080/user/userCenterInfo"
	//设置同步返回方式
	p.ReturnURL="http://192.168.73.128:8080/user/userCenterInfo"
	p.ProductCode = "FAST_INSTANT_TRADE_PAY"
	url,err:=client.TradePagePay(p)
	if err!=nil {
		this.Data["errer"]="支付失败2"
		this.TplName="place_order.html"
		return
	}

	this.Redirect(url.String(),302)
	}
```



#### 7.数据库有双花问题

1:获取未提交数据,获取储存成功后的数据,  错误数据,	脏读

2:读取已提交内容,大部分数据库默认的事务隔离级别

3:读取事务之前的数据,	mysql的默认隔离级别



所以要进行2 

改mysql配置文件   但是会把支付变成串联程序